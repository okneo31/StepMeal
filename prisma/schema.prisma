generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?
  nickname      String
  provider      String    @default("credentials") // credentials, kakao, google
  providerId    String?
  weight        Float     @default(70)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  coinBalance     CoinBalance?
  stride          Stride?
  character       Character?
  movements       Movement[]
  coinTransactions CoinTransaction[]
  dailyEarnings   DailyEarning[]
  purchases       Purchase[]
  roulettePlays   RoulettePlay[]
  quizAttempts    QuizAttempt[]
  nfts            UserNft[]
  activeBoosters  ActiveBooster[]
  quests          Quest[]
  questReviews    QuestReview[]
  orders          Order[]
  ringBets        RingBet[]
  gamePlays       GamePlay[]
  dailyMissions   DailyMission[]
  weeklyChallenges WeeklyChallenge[]
  courseAttempts   CourseAttempt[]
  achievements    UserAchievement[]

  // Theme system
  activeTheme     String   @default("default")
  unlockedThemes  String   @default("[]")        // JSON array of theme IDs
}

model CoinBalance {
  userId      String   @id
  scBalance   Int      @default(0)
  mcBalance   Int      @default(0)
  scLifetime  Int      @default(0)
  mcLifetime  Int      @default(0)
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Stride {
  userId          String   @id
  currentStreak   Int      @default(0)
  strideLevel     Int      @default(0)
  strideMultiplier Float   @default(1.0)
  longestStreak   Int      @default(0)
  lastActive      DateTime?
  shieldCount     Int      @default(0)
  totalDistance    Int      @default(0) // meters
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Movement {
  id            String   @id @default(cuid())
  userId        String
  status        String   @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  startLat      Float?
  startLng      Float?
  endLat        Float?
  endLng        Float?
  distanceM     Int      @default(0)
  durationSec   Int      @default(0)
  segments      String   @default("[]") // JSON: [{transport, distance, duration, avgSpeed, points[]}]
  transportClass String? // BODY, ECO, RIDE, MULTI
  isMulti       Boolean  @default(false)
  multiClassCount Int    @default(1)
  weather       String?
  timeSlot      String?
  calories      Float    @default(0)
  baseSc        Int      @default(0)
  transportMult Float    @default(1.0)
  strideMult    Float    @default(1.0)
  timeMult      Float    @default(1.0)
  weatherMult   Float    @default(1.0)
  multiMult     Float    @default(1.0)
  nftMult       Float    @default(1.0)
  synergyMult   Float    @default(1.0)
  conditionMult Float    @default(1.0)
  bonusSc       Int      @default(0)
  totalSc       Int      @default(0)
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  createdAt     DateTime @default(now())

  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions CoinTransaction[]

  @@index([userId, createdAt])
}

model CoinTransaction {
  id           String   @id @default(cuid())
  userId       String
  coinType     String   // SC, MC
  amount       Int      // positive=earn, negative=spend
  balanceAfter Int
  sourceType   String   // MOVEMENT, QR_SCAN, REVIEW, CHALLENGE, PURCHASE, GAME, NFT_MINT, CHECKIN
  sourceId     String?
  description  String?
  multipliers  String?  // JSON
  createdAt    DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  movement Movement? @relation(fields: [sourceId], references: [id])

  @@index([userId, coinType, createdAt])
}

model StoreItem {
  id          String   @id @default(cuid())
  category    String   // HEALTH_FOOD, IN_APP
  name        String
  description String?
  price       Int
  coinType    String   // SC, MC
  stock       Int      @default(-1) // -1 = unlimited
  imageUrl    String?
  metadata    String?  // JSON: extra info
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchases Purchase[]
}

model Purchase {
  id          String   @id @default(cuid())
  userId      String
  storeItemId String
  coinType    String   // SC, MC
  amount      Int      // price paid
  quantity    Int      @default(1)
  createdAt   DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  storeItem StoreItem @relation(fields: [storeItemId], references: [id])
  orders    Order[]

  @@index([userId, createdAt])
}

model RoulettePlay {
  id          String   @id @default(cuid())
  userId      String
  costSc      Int
  rewardType  String   // MC, SHIELD, SC, NONE
  rewardValue Int      @default(0)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model QuizQuestion {
  id           String   @id @default(cuid())
  question     String
  options      String   // JSON: string[]
  correctIndex Int
  explanation  String?
  category     String   @default("HEALTH")
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  attempts QuizAttempt[]
}

model QuizAttempt {
  id         String   @id @default(cuid())
  userId     String
  questionId String
  selectedIndex Int
  isCorrect  Boolean
  mcEarned   Int      @default(0)
  createdAt  DateTime @default(now())

  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  question QuizQuestion @relation(fields: [questionId], references: [id])

  @@index([userId, createdAt])
}

model QrCode {
  id          String    @id @default(cuid())
  code        String    @unique // e.g. STEPMEAL-QR-001
  mcReward    Int
  description String?
  isUsed      Boolean   @default(false)
  usedBy      String?   // userId
  usedAt      DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
}

model NftTemplate {
  id             String    @id @default(cuid())
  name           String
  description    String?
  imageEmoji     String
  rarity         String    // COMMON, RARE, EPIC, LEGENDARY
  category       String    @default("BADGE") // BADGE, CHARACTER, LANDSCAPE (legacy)
  nftType        String    @default("BOOSTER") // BOOSTER, ACCESSORY, VEHICLE
  priceMc        Int
  maxSupply      Int       @default(-1) // -1 = unlimited
  mintedCount    Int       @default(0)
  scBonusPercent Int       @default(0) // SC bonus %, e.g. 5, 10, 20, 30
  isActive       Boolean   @default(true)
  // Booster: tier (BRONZE, SILVER, GOLD, PLATINUM, DIAMOND)
  tier           String?
  // Accessory: slot (HEADGEAR, HANDGEAR, FOOTGEAR, BODYGEAR)
  slot           String?
  // Accessory: conditional ability JSON {condition, effect, value}
  ability        String?
  // Vehicle: matched transport types JSON ["RUN","WALK"]
  matchedTransports String?
  // Vehicle: transport class (BODY, ECO, RIDE)
  transportClass String?
  // Vehicle: synergy bonus percent when matched
  synergyPercent Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  userNfts UserNft[]
}

model UserNft {
  id              String   @id @default(cuid())
  userId          String
  templateId      String
  mintNumber      Int      // e.g. #3 of 100
  enhanceLevel    Int      @default(0) // +0 ~ +5
  isEquipped      Boolean  @default(false)
  equippedSlot    String?  // BOOSTER, HEADGEAR, HANDGEAR, FOOTGEAR, BODYGEAR, VEHICLE
  mintedAt        DateTime @default(now())

  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  template NftTemplate @relation(fields: [templateId], references: [id])

  @@index([userId])
  @@index([userId, isEquipped])
}

model Character {
  id              String   @id @default(cuid())
  userId          String   @unique
  name            String   @default("나의 캐릭터")
  avatarType      String   @default("DEFAULT") // DEFAULT, RUNNER, CYCLIST, EXPLORER, ...
  isNftAvatar     Boolean  @default(false) // true if using premium NFT avatar
  nftAvatarId     String?  // reference to UserNft if premium

  // Class system
  mainClass       String   @default("BODY") // BODY, ECO, RIDE
  subClass        String?  // secondary class

  // Level & EXP
  level           Int      @default(1)
  exp             Int      @default(0)
  expToNext       Int      @default(100) // EXP needed for next level

  // 4 Stats (base + bonus from level/gear)
  statEff         Int      @default(10) // Efficiency: SC earn rate
  statLck         Int      @default(5)  // Luck: bonus reward chance
  statChm         Int      @default(5)  // Charisma: social/game bonus
  statHp          Int      @default(10) // HP: condition decay rate

  // Condition (0-100, affects SC earning)
  condition       Int      @default(100) // current condition
  maxCondition    Int      @default(100)
  lastCondDecay   DateTime @default(now())

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DailyEarning {
  id          String   @id @default(cuid())
  userId      String
  earnDate    DateTime
  scMovement  Int      @default(0)
  scSocial    Int      @default(0)
  scChallenge Int      @default(0)
  scCheckin   Int      @default(0)
  mcQr        Int      @default(0)
  mcGame      Int      @default(0)
  distanceM   Int      @default(0)
  strideActive Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, earnDate])
  @@index([userId, earnDate])
}

model ActiveBooster {
  id          String   @id @default(cuid())
  userId      String
  boosterType String   // QR_FOOD, QR_SUPPLEMENT, QR_DRINK
  multiplier  Float    // 1.2 ~ 1.5
  productName String?
  activatedAt DateTime @default(now())
  expiresAt   DateTime // activatedAt + 24h

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId, expiresAt])
}

model Quest {
  id            String    @id @default(cuid())
  userId        String
  movementId    String?
  destName      String
  destLat       Float
  destLng       Float
  destAddress   String?
  status        String    @default("ACTIVE") // ACTIVE, ARRIVED, COMPLETED, CANCELLED
  bonusSc       Int       @default(0)
  arrivedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())

  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  review  QuestReview?
  @@index([userId, status])
}

model QuestReview {
  id        String   @id @default(cuid())
  questId   String   @unique
  userId    String
  photoUrl  String?
  comment   String?
  rating    Int?     // 1~5
  bonusSc   Int      @default(0)
  createdAt DateTime @default(now())

  quest Quest @relation(fields: [questId], references: [id])
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Order {
  id            String   @id @default(cuid())
  userId        String
  purchaseId    String
  recipientName String
  phone         String
  zipCode       String
  address       String
  addressDetail String?
  status        String   @default("ORDERED") // ORDERED, CONFIRMED, SHIPPED, DELIVERED
  trackingNo    String?
  memo          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  purchase Purchase @relation(fields: [purchaseId], references: [id])
  @@index([userId, createdAt])
}

model RingBet {
  id          String   @id @default(cuid())
  userId      String
  round       Int      // round number from API (r field)
  coinType    String   // SC or MC
  betAmount   Int      // amount wagered
  betType     String   // SLOT or NUMBER
  betValue    Int      // slot (2,3,5) or exact number (1~54)
  resultNum   Int?     // result number when settled
  resultSlot  Int?     // result slot when settled
  payout      Int      @default(0)
  status      String   @default("PENDING") // PENDING, WON, LOST
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId, createdAt])
  @@index([round, status])
}

model GamePlay {
  id          String    @id @default(cuid())
  userId      String
  gameType    String    // COINFLIP, DICE, PREDICTION
  coinType    String    // SC or MC
  betAmount   Int
  betChoice   String    // heads/tails, odd/even/high/low/exact:N, 1/2/3/5 (km)
  result      String?   // heads/tails, 1-6, distance
  multiplier  Float     @default(0)
  payout      Int       @default(0)
  status      String    @default("PENDING") // PENDING, WON, LOST
  createdAt   DateTime  @default(now())
  resolvedAt  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId, gameType, createdAt])
}

// ─── Daily Mission System ───
model DailyMission {
  id           String   @id @default(cuid())
  userId       String
  missionDate  DateTime
  slot         Int      // 1, 2, 3
  missionType  String   // WALK_DIST, TOTAL_DIST, QUEST_COMPLETE, MOVE_COUNT, GAME_PLAY
  description  String
  targetValue  Int
  currentValue Int      @default(0)
  rewardSc     Int      @default(0)
  rewardMc     Int      @default(0)
  status       String   @default("ACTIVE") // ACTIVE, COMPLETED, CLAIMED
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([userId, missionDate, slot])
  @@index([userId, missionDate])
}

// ─── Weekly Challenge ───
model WeeklyChallenge {
  id              String   @id @default(cuid())
  userId          String
  weekStart       DateTime
  totalDistanceM  Int      @default(0)
  moveCount       Int      @default(0)
  bronzeClaimed   Boolean  @default(false)
  silverClaimed   Boolean  @default(false)
  goldClaimed     Boolean  @default(false)
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([userId, weekStart])
}

// ─── Multi-Point Course Quest ───
model CourseQuest {
  id              String   @id @default(cuid())
  name            String
  description     String?
  category        String   @default("TOUR") // HEALTH, FOOD, TOUR
  checkpoints     String   // JSON: [{name, lat, lng, address, rewardSc, radiusM}]
  completionBonus Int      @default(100)
  estimatedKm     Float    @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  attempts CourseAttempt[]
}

model CourseAttempt {
  id                String    @id @default(cuid())
  userId            String
  courseId           String
  currentCheckpoint Int       @default(0)
  completedChecks   String    @default("[]") // JSON: completed checkpoint indices
  totalEarned       Int       @default(0)
  status            String    @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  startedAt         DateTime  @default(now())
  completedAt       DateTime?

  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  course CourseQuest @relation(fields: [courseId], references: [id])
  @@index([userId, status])
}

// ─── Achievement / Badge System ───
model UserAchievement {
  id              String    @id @default(cuid())
  userId          String
  achievementCode String
  progress        Int       @default(0)
  completed       Boolean   @default(false)
  completedAt     DateTime?
  claimed         Boolean   @default(false)
  createdAt       DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([userId, achievementCode])
  @@index([userId, completed])
}
