generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?
  nickname      String
  provider      String    @default("credentials") // credentials, kakao, google
  providerId    String?
  weight        Float     @default(70)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  coinBalance     CoinBalance?
  stride          Stride?
  movements       Movement[]
  coinTransactions CoinTransaction[]
  dailyEarnings   DailyEarning[]
  purchases       Purchase[]
  roulettePlays   RoulettePlay[]
  quizAttempts    QuizAttempt[]
}

model CoinBalance {
  userId      String   @id
  scBalance   Int      @default(0)
  mcBalance   Int      @default(0)
  scLifetime  Int      @default(0)
  mcLifetime  Int      @default(0)
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Stride {
  userId          String   @id
  currentStreak   Int      @default(0)
  strideLevel     Int      @default(0)
  strideMultiplier Float   @default(1.0)
  longestStreak   Int      @default(0)
  lastActive      DateTime?
  shieldCount     Int      @default(0)
  totalDistance    Int      @default(0) // meters
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Movement {
  id            String   @id @default(cuid())
  userId        String
  status        String   @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  startLat      Float?
  startLng      Float?
  endLat        Float?
  endLng        Float?
  distanceM     Int      @default(0)
  durationSec   Int      @default(0)
  segments      String   @default("[]") // JSON: [{transport, distance, duration, avgSpeed, points[]}]
  transportClass String? // BODY, ECO, RIDE, MULTI
  isMulti       Boolean  @default(false)
  multiClassCount Int    @default(1)
  weather       String?
  timeSlot      String?
  calories      Float    @default(0)
  baseSc        Int      @default(0)
  transportMult Float    @default(1.0)
  strideMult    Float    @default(1.0)
  timeMult      Float    @default(1.0)
  weatherMult   Float    @default(1.0)
  multiMult     Float    @default(1.0)
  bonusSc       Int      @default(0)
  totalSc       Int      @default(0)
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  createdAt     DateTime @default(now())

  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions CoinTransaction[]

  @@index([userId, createdAt])
}

model CoinTransaction {
  id           String   @id @default(cuid())
  userId       String
  coinType     String   // SC, MC
  amount       Int      // positive=earn, negative=spend
  balanceAfter Int
  sourceType   String   // MOVEMENT, QR_SCAN, REVIEW, CHALLENGE, PURCHASE, GAME, NFT_MINT, CHECKIN
  sourceId     String?
  description  String?
  multipliers  String?  // JSON
  createdAt    DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  movement Movement? @relation(fields: [sourceId], references: [id])

  @@index([userId, coinType, createdAt])
}

model StoreItem {
  id          String   @id @default(cuid())
  category    String   // HEALTH_FOOD, IN_APP
  name        String
  description String?
  price       Int
  coinType    String   // SC, MC
  stock       Int      @default(-1) // -1 = unlimited
  imageUrl    String?
  metadata    String?  // JSON: extra info
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchases Purchase[]
}

model Purchase {
  id          String   @id @default(cuid())
  userId      String
  storeItemId String
  coinType    String   // SC, MC
  amount      Int      // price paid
  quantity    Int      @default(1)
  createdAt   DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  storeItem StoreItem @relation(fields: [storeItemId], references: [id])

  @@index([userId, createdAt])
}

model RoulettePlay {
  id          String   @id @default(cuid())
  userId      String
  costSc      Int
  rewardType  String   // MC, SHIELD, SC, NONE
  rewardValue Int      @default(0)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model QuizQuestion {
  id           String   @id @default(cuid())
  question     String
  options      String   // JSON: string[]
  correctIndex Int
  explanation  String?
  category     String   @default("HEALTH")
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  attempts QuizAttempt[]
}

model QuizAttempt {
  id         String   @id @default(cuid())
  userId     String
  questionId String
  selectedIndex Int
  isCorrect  Boolean
  mcEarned   Int      @default(0)
  createdAt  DateTime @default(now())

  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  question QuizQuestion @relation(fields: [questionId], references: [id])

  @@index([userId, createdAt])
}

model DailyEarning {
  id          String   @id @default(cuid())
  userId      String
  earnDate    DateTime
  scMovement  Int      @default(0)
  scSocial    Int      @default(0)
  scChallenge Int      @default(0)
  scCheckin   Int      @default(0)
  mcQr        Int      @default(0)
  mcGame      Int      @default(0)
  distanceM   Int      @default(0)
  strideActive Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, earnDate])
  @@index([userId, earnDate])
}
